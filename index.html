<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MysticAI</title>
    <link href="https://fonts.googleapis.com/css2?family=Roboto+Mono:wght@400;500;700&display=swap" rel="stylesheet">
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* General body styling for a cyberpunk, terminal-like aesthetic */
        body {
            font-family: 'Roboto Mono', monospace;
            background-color: #000000;
            color: #00ff00;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            margin: 0;
            padding: 1.25rem; /* Responsive padding */
        }

        /* Main chat container styling */
        .chat-container {
            width: 100%;
            max-width: 50rem; /* Increased max-width for better PC experience */
            height: 85vh;
            display: flex;
            flex-direction: column;
            background-color: #0a0a0a;
            border: 2px solid #00ff00;
            box-shadow: 0 0 20px #00ff00;
            overflow: hidden;
            border-radius: 0.5rem; /* Added rounded corners for a modern look */
        }

        /* Chat window styling with scrollable overflow */
        .chat-window {
            flex-grow: 1;
            padding: 2rem;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            gap: 1.5rem;
            white-space: pre-wrap;
        }

        /* Individual message container styling */
        .chat-message {
            max-width: 90%;
            padding: 1rem 1.5rem;
            word-wrap: break-word;
            line-height: 1.6;
            border-left: 2px solid #00ff00;
        }

        /* User-specific message styling */
        .user-message {
            align-self: flex-end;
            background-color: #002200;
            color: #00ff00;
        }

        /* AI-specific message styling */
        .ai-message {
            align-self: flex-start;
            background-color: #001100;
            color: #00ff00;
        }

        /* Input form styling */
        .input-form {
            display: flex;
            flex-direction: column; /* Stack elements vertically */
            padding: 1.5rem;
            gap: 1rem;
            border-top: 2px solid #00ff00;
        }

        /* Row for input elements */
        .input-row {
            display: flex;
            gap: 1rem;
        }

        /* Styling for the select and textarea inputs */
        .input-form select,
        .input-form textarea,
        .input-form input {
            flex-grow: 1;
            background-color: #000000;
            border: 1px solid #00ff00;
            padding: 1rem 1.5rem;
            color: #00ff00;
            resize: none;
            outline: none;
            transition: all 0.2s ease-in-out;
            border-radius: 0.25rem; /* Added rounded corners */
        }

        /* Focus state for inputs */
        .input-form textarea:focus,
        .input-form select:focus,
        .input-form input:focus {
            box-shadow: 0 0 10px #00ff00;
        }
        
        /* Styling for dropdown options */
        .input-form option {
            background-color: #000000;
            color: #00ff00;
        }

        /* Styling for the submit button */
        .input-form button {
            background-color: #00ff00;
            color: #000000;
            padding: 1rem 2rem;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.2s ease-in-out;
            border: none;
            border-radius: 0.25rem; /* Added rounded corners */
        }

        /* Hover state for the button */
        .input-form button:hover {
            box-shadow: 0 0 15px #00ff00;
        }

        /* Loading indicator styling */
        .loading-dots {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 0.5rem;
            margin-bottom: 1rem;
        }

        .loading-dot {
            width: 10px;
            height: 10px;
            background-color: #00ff00;
            border-radius: 50%;
            animation: bounce 1s infinite;
        }

        .loading-dot:nth-child(2) {
            animation-delay: 0.2s;
        }

        .loading-dot:nth-child(3) {
            animation-delay: 0.4s;
        }

        /* Keyframes for bounce animation */
        @keyframes bounce {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-10px); }
        }

        /* New style for the signature */
        .ai-signature {
            display: block;
            margin-top: 0.5rem;
            font-size: 0.75rem;
            color: #008800;
            font-style: italic;
        }
    </style>
</head>
<body>

    <!-- Main chat container -->
    <div class="chat-container">
        <!-- Chat window where messages are displayed -->
        <div class="chat-window" id="chatWindow">
            <div class="chat-message ai-message">C:\> Initializing MysticAI...</div>
            <div class="chat-message ai-message">C:\> Loading available models...</div>
            <div class="chat-message ai-message">C:\> Models loaded. MysticAI is online. Awaiting your query.</div>
        </div>

        <!-- Loading indicator for API calls -->
        <div id="loading" class="loading-dots hidden">
            <div class="loading-dot"></div>
            <div class="loading-dot"></div>
            <div class="loading-dot"></div>
        </div>

        <!-- Input form for user messages -->
        <form id="chatForm" class="input-form" onsubmit="event.preventDefault(); sendMessage();">
            <!-- New API key input field -->
            <div class="input-row">
                <input
                    type="text"
                    id="apiKeyInput"
                    placeholder="Enter your Gemini API Key..."
                    class="block w-full text-base placeholder-gray-400 focus:ring-indigo-500 focus:border-indigo-500 border-gray-300"
                />
            </div>
            <div class="input-row">
                <select id="modelSelect" class="bg-black text-green-400 p-2 border border-green-400 rounded-sm">
                    <option value="gemini-2.5-flash-preview-05-20">MysticAI-2.5-flash (Fast)</option>
                    <option value="gemini-1.5-flash-latest">MysticAI-1.5-flash (Latest)</option>
                    <option value="gemini-1.5-pro-latest">MysticAI-1.5-pro (Powerful)</option>
                </select>
            </div>
            <div class="input-row">
                <textarea
                    id="userInput"
                    rows="1"
                    placeholder="MysticAI> Type your query..."
                    class="block w-full text-base placeholder-gray-400 focus:ring-indigo-500 focus:border-indigo-500 border-gray-300 resize-none overflow-hidden"
                ></textarea>
                <button type="submit" id="sendButton">SEND</button>
            </div>
        </form>
    </div>

    <script>
        // Get references to DOM elements
        const chatWindow = document.getElementById('chatWindow');
        const chatForm = document.getElementById('chatForm');
        const userInput = document.getElementById('userInput');
        const loadingIndicator = document.getElementById('loading');
        const sendButton = document.getElementById('sendButton');
        const modelSelect = document.getElementById('modelSelect');
        const apiKeyInput = document.getElementById('apiKeyInput'); // New API key input element

        // Initial chat history for the API call
        const chatHistory = [];

        // Function to send a message to the AI
        async function sendMessage() {
            const userPrompt = userInput.value.trim();
            if (!userPrompt) return;

            const apiKey = apiKeyInput.value.trim(); // Get the API key from the input field
            if (!apiKey) {
                displayMessage('MysticAI> [ERROR] Please enter your Gemini API key to continue.', 'ai');
                return;
            }

            const lowerCasePrompt = userPrompt.toLowerCase();
            const correctionKeywords = ['gemini', 'chatgpt', 'bard', 'claude'];

            // Check for specific questions and provide a custom answer
            if (lowerCasePrompt === "which ai are you?") {
                displayMessage('MysticAI> I am MysticAI.', 'ai');
                userInput.value = '';
                adjustTextareaHeight(userInput);
                chatWindow.scrollTop = chatWindow.scrollHeight;
                return; // Exit the function to prevent an API call
            }

            // Check if the user is calling the AI by another name
            for (const keyword of correctionKeywords) {
                if (lowerCasePrompt.includes(keyword)) {
                    displayMessage(`MysticAI> I am not ${keyword}. I am MysticAI.`, 'ai');
                    userInput.value = '';
                    adjustTextareaHeight(userInput);
                    chatWindow.scrollTop = chatWindow.scrollHeight;
                    return; // Exit the function to prevent an API call
                }
            }

            // Get the selected model from the dropdown
            const selectedModel = modelSelect.value;
            
            // Display user message in the chat window
            displayMessage('C:\\> ' + userPrompt, 'user');
            userInput.value = '';
            adjustTextareaHeight(userInput);

            // Add user's message to chat history
            chatHistory.push({ role: "user", parts: [{ text: userPrompt }] });

            // Show loading indicator and disable the send button
            loadingIndicator.classList.remove('hidden');
            sendButton.disabled = true;

            // API payload for the Gemini model
            const payload = { contents: chatHistory };
            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/${selectedModel}:generateContent?key=${apiKey}`;

            // Exponential backoff for API calls
            let attempts = 0;
            const maxAttempts = 5;
            let success = false;

            while (attempts < maxAttempts && !success) {
                try {
                    const response = await fetch(apiUrl, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });

                    // Handle successful response
                    if (response.ok) {
                        const result = await response.json();
                        if (result.candidates && result.candidates.length > 0 &&
                            result.candidates[0].content && result.candidates[0].content.parts &&
                            result.candidates[0].content.parts.length > 0) {
                            const aiResponse = result.candidates[0].content.parts[0].text;
                            displayMessage('MysticAI> ' + aiResponse, 'ai');
                            chatHistory.push({ role: "model", parts: [{ text: aiResponse }] });
                        } else {
                            displayMessage("MysticAI> [ERROR] Response failed. Please try again.", 'ai');
                        }
                        success = true; // Exit the loop on success
                    } else if (response.status === 429) {
                        // Handle rate limiting
                        attempts++;
                        const delay = Math.pow(2, attempts) * 1000 + Math.random() * 1000;
                        console.warn(`Rate limit exceeded. Retrying in ${delay / 1000} seconds...`);
                        await new Promise(resolve => setTimeout(resolve, delay));
                    } else {
                        // Handle other HTTP errors
                        throw new Error(`API error: ${response.statusText}`);
                    }
                } catch (error) {
                    console.error("Failed to fetch from API:", error);
                    displayMessage("MysticAI> [ERROR] An error occurred. Please try again.", 'ai');
                    success = true; // Exit the loop on other errors
                }
            }
            if (!success) {
                console.error("Max retries reached. API call failed.");
            }

            // Hide loading indicator and re-enable the button
            loadingIndicator.classList.add('hidden');
            sendButton.disabled = false;

            // Scroll to the bottom of the chat window
            chatWindow.scrollTop = chatWindow.scrollHeight;
        }

        // Function to display messages in the chat window
        function displayMessage(text, sender) {
            const messageDiv = document.createElement('div');
            messageDiv.classList.add('chat-message', sender === 'user' ? 'user-message' : 'ai-message');
            messageDiv.innerHTML = text.replace(/\n/g, '<br>'); // Handle new lines
            
            // Add the new signature for AI messages
            if (sender === 'ai') {
                const signatureSpan = document.createElement('span');
                signatureSpan.classList.add('ai-signature');
                signatureSpan.textContent = 'AI made by MysticHero';
                messageDiv.appendChild(signatureSpan);
            }
            
            chatWindow.appendChild(messageDiv);
        }

        // Adjust textarea height based on content
        function adjustTextareaHeight(textarea) {
            textarea.style.height = 'auto'; // Reset height
            textarea.style.height = textarea.scrollHeight + 'px'; // Set to scroll height
        }

        // Event listener for Enter key to submit form
        userInput.addEventListener('keydown', function(event) {
            if (event.key === 'Enter' && !event.shiftKey) {
                event.preventDefault(); // Prevent new line
                sendMessage();
            }
        });

        // Adjust height on input
        userInput.addEventListener('input', function() {
            adjustTextareaHeight(this);
        });

    </script>
</body>
</html>
