<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MysticAI Chatbot</title>
    <!-- Tailwind CSS CDN for modern styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Custom CSS for animations and futuristic theme -->
    <style>
        body {
            font-family: 'Roboto Mono', monospace;
            background-color: #000000;
            color: #00ff00;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            margin: 0;
            padding: 1.25rem;
        }
        @keyframes bounce {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-10px); }
        }
    </style>
</head>
<body>
    <!-- Main container of the application -->
    <div class="flex justify-center items-center min-h-screen p-5 bg-black text-green-500 font-mono">
        <div id="chatbot-container" class="w-full max-w-3xl h-[85vh] flex flex-col bg-[#0a0a0a] border-2 border-green-500 shadow-[0_0_20px_#00ff00] rounded-md overflow-hidden">
            
            <!-- Chat window for messages -->
            <div id="chat-window" class="flex-grow p-8 overflow-y-auto flex flex-col gap-6 whitespace-pre-wrap">
                <!-- Chat messages will be dynamically added here by JavaScript -->
            </div>

            <!-- Loading indicator for API calls -->
            <div id="loading-indicator" class="hidden flex justify-center items-center gap-2 my-4">
                <div class="w-2.5 h-2.5 bg-green-500 rounded-full animate-[bounce_1s_infinite]"></div>
                <div class="w-2.5 h-2.5 bg-green-500 rounded-full animate-[bounce_1s_infinite_0.2s]"></div>
                <div class="w-2.5 h-2.5 bg-green-500 rounded-full animate-[bounce_1s_infinite_0.4s]"></div>
            </div>

            <!-- Input form for user queries -->
            <form id="input-form" class="flex flex-col p-6 gap-4 border-t-2 border-green-500">
                <textarea
                    id="user-input"
                    rows="1"
                    placeholder="MysticAI> Type your query..."
                    class="block w-full text-base bg-black placeholder-gray-400 focus:ring-green-500 focus:border-green-500 border-green-500 resize-none rounded-md p-4 transition-all duration-200"
                ></textarea>
                <button
                    type="submit"
                    id="submit-button"
                    class="w-full md:w-auto bg-green-500 text-black font-bold py-3 px-6 rounded-md cursor-pointer transition-all duration-200 disabled:opacity-50 disabled:cursor-not-allowed hover:shadow-[0_0_15px_#00ff00]"
                >
                    SEND
                </button>
            </form>
        </div>
    </div>

    <!-- Firebase SDKs are imported here -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        
        // --- Core Application Logic ---

        // Get elements from the DOM
        const chatWindow = document.getElementById('chat-window');
        const userInput = document.getElementById('user-input');
        const inputForm = document.getElementById('input-form');
        const submitButton = document.getElementById('submit-button');
        const loadingIndicator = document.getElementById('loading-indicator');

        // These variables are provided by the Canvas environment for secure access.
        // On your public website, a backend function will need to provide these.
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {};
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;
        const selectedModel = "gemini-2.5-flash-preview-05-20";

        // Firebase service instances
        let app, auth;

        // Function to add a new message to the chat window
        function addMessage(text, sender) {
            const messageElement = document.createElement('div');
            messageElement.classList.add('max-w-[90%]', 'p-4', 'rounded-md', 'border-l-2');
            messageElement.classList.add(sender === 'user' ? 'self-end' : 'self-start');
            messageElement.classList.add(sender === 'user' ? 'bg-[#002200]' : 'bg-[#001100]');
            messageElement.classList.add('border-green-500');

            messageElement.textContent = text;
            
            // Add the "AI made by MysticHero" text for AI messages
            if (sender === 'ai') {
                const creditSpan = document.createElement('span');
                creditSpan.classList.add('block', 'mt-2', 'text-xs', 'text-green-700', 'italic');
                creditSpan.textContent = 'AI made by MysticHero';
                messageElement.appendChild(creditSpan);
            }

            chatWindow.appendChild(messageElement);
            // Scroll to the bottom to show the newest message
            chatWindow.scrollTop = chatWindow.scrollHeight;
        }

        // Function to handle the loading state
        function setLoading(isLoading) {
            if (isLoading) {
                loadingIndicator.classList.remove('hidden');
                submitButton.disabled = true;
            } else {
                loadingIndicator.classList.add('hidden');
                submitButton.disabled = false;
            }
        }

        // Handles the form submission
        async function handleFormSubmit(e) {
            e.preventDefault();
            const userPrompt = userInput.value.trim();
            if (!userPrompt) return;

            addMessage(`C:\\> ${userPrompt}`, 'user');
            userInput.value = '';
            setLoading(true);

            // API URL and payload, using a securely provided API key from the environment.
            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/${selectedModel}:generateContent?key=${firebaseConfig.apiKey}`;
            const payload = { 
                contents: [{ 
                    role: "user", 
                    parts: [{ text: userPrompt }] 
                }] 
            };

            try {
                // Exponential backoff for retries to handle rate limiting or temporary network issues
                let response, result;
                let retries = 0;
                const maxRetries = 5;
                const baseDelay = 1000; // 1 second

                while (retries < maxRetries) {
                    try {
                        response = await fetch(apiUrl, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify(payload)
                        });

                        result = await response.json();
                        
                        if (response.ok) {
                            break; // Success, exit the retry loop
                        } else if (response.status === 429) {
                            // Too Many Requests, retry with delay
                            console.warn(`Rate limit exceeded. Retrying in ${baseDelay * Math.pow(2, retries)}ms...`);
                            await new Promise(resolve => setTimeout(resolve, baseDelay * Math.pow(2, retries)));
                            retries++;
                        } else {
                            // Other error, break and handle it
                            break;
                        }
                    } catch (error) {
                        console.error("Fetch attempt failed:", error);
                        await new Promise(resolve => setTimeout(resolve, baseDelay * Math.pow(2, retries)));
                        retries++;
                    }
                }

                let aiResponse = "Response failed. Please try again.";
                
                if (result && result.candidates && result.candidates.length > 0 &&
                    result.candidates[0].content && result.candidates[0].content.parts &&
                    result.candidates[0].content.parts.length > 0) {
                    aiResponse = result.candidates[0].content.parts[0].text;
                } else if (result && result.error) {
                    aiResponse = `[ERROR] ${result.error.message}`;
                    console.error('API Error:', result);
                } else {
                    aiResponse = "MysticAI> [ERROR] Failed to get a valid response from the API after multiple attempts.";
                }

                addMessage(`MysticAI> ${aiResponse}`, 'ai');

            } catch (error) {
                console.error("Connection failed:", error);
                addMessage("MysticAI> [ERROR] Connection to the AI failed. Please check your network or try again later.", 'ai');
            } finally {
                setLoading(false);
            }
        }

        // Initialize the Firebase app and authenticate the user
        async function initializeAppAndAuth() {
            try {
                if (Object.keys(firebaseConfig).length > 0) {
                    app = initializeApp(firebaseConfig);
                    auth = getAuth(app);

                    if (initialAuthToken) {
                        await signInWithCustomToken(auth, initialAuthToken);
                        console.log("Firebase signed in with custom token.");
                    } else {
                        await signInAnonymously(auth);
                        console.log("Firebase signed in anonymously.");
                    }
                } else {
                    console.error("Firebase config is not available. Please ensure it's set up in your environment.");
                }

                // Initial messages after successful authentication
                addMessage('C:\\> Initializing MysticAI...', 'ai');
                setTimeout(() => addMessage('C:\\> Loading available models...', 'ai'), 1000);
                setTimeout(() => addMessage('C:\\> Models loaded. MysticAI is online. Awaiting your query.', 'ai'), 2000);

                // Add the event listener for form submission
                inputForm.addEventListener('submit', handleFormSubmit);

                // Also add an event listener for the 'Enter' key in the text area
                userInput.addEventListener('keydown', (e) => {
                    if (e.key === 'Enter' && !e.shiftKey) {
                        handleFormSubmit(e);
                    }
                });

            } catch (error) {
                console.error("Firebase initialization or authentication failed:", error);
                addMessage(`MysticAI> [ERROR] Failed to connect to Firebase. Please check your project setup.`, 'ai');
            }
        }

        // Initialize on window load
        window.onload = initializeAppAndAuth;
    </script>
</body>
</html>
